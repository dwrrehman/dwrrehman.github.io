<!DOCTYPE html>
<html>
	<head>
		<style type="text/css">
		
			#container {
				width: screen.width;
				height: screen.height;				
				border: none;
				margin: 0 auto;				
			}

			#text{
    			border: none;
				color: #3AFD33;	
				font-family: Menlo;
				font-size: large;	
				font-weight: lighter;			
				background-color: transparent;	
				caret-color: #3AFD33;

    			width: 100%;
				height : 100%;
				max-height: 1000px;				
    			overflow: auto;
			}

			*:focus {
    			outline: none;
			}

			html, body {
				padding:0; 
				margin:0;
				background: black;
			}
		</style>

		<script type="text/javascript">

			/*

			things to do:

				- make the delete command work
				- make th3 count command work 				
				- allow sudo, and permissons
				- 
			*/





			var manuals = {
				"help": "simply type help, and read the help menu. not that complicated.", 
				"edit": "edits a file on the file system. _return is used in js code to print something to the screen. _parameters is used to access the list of strings passed into the program, when executed.",
				"list": "lists the files in the current directory, or contents of a file.",				
				"change": "changes current directory",
				"pwd": "prints the current directory you are in.",
				"delete": "deletes a set of files, or directories.",
				"execute": "executes a file, as javascript code. uses _return, and _parameters, to do input and output."
			}	

			var prompt_begin = ":";
			var prompt_emblem = ":>";
			var current_directory = "/";
			var welcome_message = "This is a Command Line Interface For Daniel's Website. <br>type \"?\" for more info.";
			var commandline_mode = true;
			var has_focused_before = false;			
			var last_target;
			var file_being_edited = "";
			var filepath_being_edited = "";

			function file(filename, filedata) {								
				this.filename = filename;
				this.filedata = filedata;
			}

			var files = new Object(); // array of all files.
			

			function prompt_string() {
				return prompt_begin + current_directory + prompt_emblem + String.fromCharCode(160);			
			}


			// stubs for executed javscript to use to interact with the terminal.
			var _return;
			var _parameters;

			function interpret(commandstring) {				
				var commandlist = commandstring.trim().split(' ');
				var command = commandlist[0];

				if (command == "help" || command == "?") {
					return "commands:\nedit(ed) <file> \nlist(ls) <file> \npresent(pwd) \nchange(cd) <file> \ndump \ndelete(rm) <file> \ncount(c) <file> \nclear(l) \nmanual(man) <command> \nhelp(?) \nexecute(x) <file>\n   Use \"~\" or Esc to exit the text editor.\n\n";

				} else if (command == "edit" || command == "e") {
					commandline_mode = false;
					file_being_edited = commandlist[1];
					filepath_being_edited = current_directory + file_being_edited + "/";
					var initial_data = "";
					if (files[filepath_being_edited] === undefined) {
						files[current_directory].filedata += file_being_edited + "\n";
					} else {
						initial_data = files[filepath_being_edited].filedata;
					}					
					document.getElementById("text").innerText = initial_data;
					return "";

				} else if (command == "delete" || command == "rm" ) {										
					files[current_directory + commandlist[1] + "/"] = undefined;
					/// files[current_directory].filedata // remove line in this file, that says the commandlist[1] file even exists anymore.
					return "";

				} else if (command == "execute" || command == "x") {
					_return = "";
					_parameters = commandlist;
					eval(files[current_directory + commandlist[1] + "/"].filedata);
					return _return;

				} else if (command == "change" || command == "cd") {

					if (commandlist[1] == ".." && current_directory != "/") {
						var index = current_directory.slice(0, current_directory.length - 1).lastIndexOf("/");
						current_directory = current_directory.slice(0, index + 1);

					} else if (commandlist[1] == ".") {		

					} else {						
						var directory_exists = false;
						var files_in_current_directory = files[current_directory].filedata.split('\n');
						for (var i = 0; i < files_in_current_directory.length; i++) {
							if (files_in_current_directory[i] == commandlist[1] && files[current_directory + files_in_current_directory[i] + "/"] != undefined) {
								directory_exists = true;
							}
						}
						if (directory_exists) 
							current_directory += commandlist[1] + "/";	 // only relative movement through fs.			
					}
					return "";

				} else if (command == "pwd" || command == "p") {
					return current_directory + "\n";					


				} else if (command == "man" || command == "m") {
					if (manuals[commandlist[1]] != undefined) {
						return manuals[commandlist[1]] + "\n";
					} else {
						return "";
					}
				} else if (command == "list" || command == "ls") {
					if (commandlist[1] != undefined) {
						if (files[current_directory + commandlist[1] + "/"] != undefined) {
							return files[current_directory + commandlist[1] + "/"].filedata;
						}
					} else {
						return files[current_directory].filedata;
					}
					return "";

				} else if (command == "clear" || command == "l") {
					document.getElementById("text").innerHTML = "";	
					return "";

				} else if (command == "count" || command == "c") {
					if (files[commandlist[1]] != undefined)
						return (files[commandlist[1]].length) + "\n";

				} else if (command == "dump") {
					return JSON.stringify(files) + "\n";

				} else if (command == "") {
					return "";
				} else {
					return "?\n";
				}				
			}

			function placeCaretAtEnd(el) {
    			el.focus();
    			if (typeof window.getSelection != "undefined" && typeof document.createRange != "undefined") {
        			var range = document.createRange();
        			range.selectNodeContents(el);
        			range.collapse(false);
        			var sel = window.getSelection();
        			sel.removeAllRanges();
        			sel.addRange(range);
    			} else if (typeof document.body.createTextRange != "undefined") {
        			var textRange = document.body.createTextRange();
        			textRange.moveToElementText(el);
        			textRange.collapse(false);
        			textRange.select();
    			}
			}

			function on_focus() {
				if (!has_focused_before) {
					has_focused_before = true;
					files["/"] = new file("", "");
					document.getElementById("text").innerHTML = welcome_message + "<br>" + prompt_string();		
				}
				placeCaretAtEnd(document.getElementById("text"));						
			}

			window.onload = function() {
				document.addEventListener('keyup', function(event) { 					
					var last_character_in_text = document.getElementById("text").innerText.slice(-1);

					// command line mode:
					if (commandline_mode && event.key == "Enter" && last_character_in_text == "\n") {
						// get command:
						var start_index = document.getElementById("text").innerText.lastIndexOf(prompt_emblem) + prompt_emblem.length + 1;
						var end_index = document.getElementById("text").innerText.length - 2;
						var command = document.getElementById("text").innerText.slice(start_index, end_index);					
						var result = interpret(command);

						// prompt again
						if (file_being_edited == "") {
							document.getElementById("text").innerText = document.getElementById("text").innerText.slice(0, document.getElementById("text").innerText.length-1);
						}

						document.getElementById("text").innerText += result;
						if (commandline_mode) 
							document.getElementById("text").innerText += prompt_string();	

						placeCaretAtEnd(document.getElementById("text"))

					// text mode:
					} else if (!commandline_mode && (event.key == "Escape" || event.key == "~")) {						
						if (event.key == "~") {	
							document.getElementById("text").innerText = document.getElementById("text").innerText.slice(0, document.getElementById("text").innerText.length-1);						
						}

						files[filepath_being_edited] = new file(file_being_edited, document.getElementById("text").innerText);
						commandline_mode = true;
						document.getElementById("text").innerText = prompt_string();	
						placeCaretAtEnd(document.getElementById("text"));
						file_being_edited = "";
						filepath_being_edited = "";
					}
				}, false);
			}    		
	
		</script>
	</head>
	<body>
		<div id="container">			
			<div 
				id="text" 
				contenteditable="true" 
				onfocus="on_focus();" 				
				autocomplete="off" 
				autocorrect="off" 
				autocapitalize="off" 
				spellcheck="false">click me</div>						
		</div>
	</body>
</html>